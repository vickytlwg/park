<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
 PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.park.dao.AccessDAO">
	<resultMap id="AccessMapper" type="Access">
		<id property="id" column="id" />
		<result property="channelId" column="channelId" />
		<result property="date" column="date"/>
		<result property="isDeleted" column="isDeleted"/>
	</resultMap> 

	<resultMap id="AccessDetailMapper" type="com.park.model.AccessDetail">
		<id property="id" column="access_Id" />
		<result property="name" column="park_name" />
		<result property="channelNumber" column="channel_channelId"/>
		<result property="date" column="access_date"/>
	</resultMap> 
	
	<select id="getAccesses" resultMap="AccessMapper">
		select * from access
	</select>
	
	<select id="getHourCountByPark" resultType="java.util.HashMap">
		select channel.parkId, channel.channelFlag,  HOUR(access.date) as hour, count(*) as count from access 
		left join channel on access.channelId = channel.id  where channel.parkId=#{parkId} and Date(access.date)=#{date}
		group by channel.channelFlag,date_format(access.date, '%Y-%m-%d %H')
	</select>
	
	<select id="getHourCountByChannel" resultType="java.util.HashMap">
		select channel.parkId, channel.macId, channel.channelFlag, HOUR(access.date) as hour, count(*) as count from access 
		left join channel on access.channelId = channel.id where channel.parkId=#{parkId} and Date(access.date)=#{date}
		group by channel.macId, date_format(access.date, '%Y-%m-%d %H')
	</select>
	
	<select id="getMonthCountByPark" resultType="java.util.HashMap">
		select channel.parkId, channel.channelFlag, MONTH(access.date) as month, count(*) as count from access 
		left join channel on access.channelId = channel.id  where channel.parkId=#{parkId} and YEAR(access.date) = #{year}
		group by channel.channelFlag,date_format(access.date, '%Y-%m')
	</select>
	
	<select id="getMonthCountByChannel" resultType="java.util.HashMap">
		select channel.parkId, channel.macId, channel.channelFlag, MONTH(access.date) as month, count(*) as count from access 
		left join channel on access.channelId = channel.id where channel.parkId=#{parkId} and YEAR(access.date) = #{year}
		group by channel.macId, date_format(access.date, '%Y-%m')
	</select>
	
	<select id="getChannelHourCount" resultType="java.util.HashMap">
		select channel.parkId, channel.macId, channel.channelFlag, HOUR(access.date) as hour, count(*) as count from access 
		left join channel on access.channelId = channel.id where channel.macId=#{macId} and Date(access.date)=#{date}
		group by channel.macId, date_format(access.date, '%Y-%m-%d %H')
	</select>
	
	<select id="getChannelMonthCount" resultType="java.util.HashMap">
		select channel.parkId, channel.channelFlag, MONTH(access.date) as month, count(*) as count from access 
		left join channel on access.channelId = channel.id  where channel.macId=#{macId} and YEAR(access.date) = #{year}
		group by channel.channelFlag,date_format(access.date, '%Y-%m')
	</select>
	
	<select id="getAccessDetail" resultMap="AccessDetailMapper">
		select access.id as access_Id, park.name as park_name, channel.channelId as channel_channelId, access.date as access_date from access 
		left join channel on access.channelId = channel.Id
		left join park on channel.parkId = park.Id
		order by access.date desc
		limit #{low}, #{count}
	</select> 
	
	
	 
	<select id="getParkAccessDetail" resultMap="AccessDetailMapper">
	{call P_getParkAccessDetail(#{low,jdbcType=INTEGER,mode=IN},#{count,jdbcType=INTEGER,mode=IN})}
	</select> 
	
	<select id="getAccessCount"  resultType="int">
		select count(*) from access
	</select>
	
	
	<select id="getParkAccessCount"  resultType="int">
		select count(*) from access 
		left join channel on access.channelId = channel.Id
		where channel.parkId = #{param1}
	</select>
	
	<insert id="insertAccess" parameterType="Access" keyProperty="id">
	    insert into access(channelId,date,isDeleted) values (#{channelId},#{date}, #{isDeleted})
	</insert>
	
	<update id="updateAccess" parameterType="Access" >
		update access set channelId = #{channelId}, date = #{date}, isDeleted = #{isDeleted} where Id = #{Id}
	</update>
	
	<delete id="deleteAccess" parameterType="int">
		delete from access where id = #{id}
	</delete>
</mapper>